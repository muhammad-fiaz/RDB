name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate Changelog
        id: changelog
        run: |
          echo "## ‚ú® What's New" > changelog.md
          if git describe --tags --abbrev=0 HEAD^ > /dev/null 2>&1; then
            git log --pretty=format:"%s (%h)" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> changelog.md
          else
            git log --pretty=format:"%s (%h)" --max-count=20 >> changelog.md
          fi
          content=$(cat changelog.md)
          echo "content=$content" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: RDB v${{ steps.get_version.outputs.version }}
          body: |
            # üöÄ RDB v${{ steps.get_version.outputs.version }}
            
            High-performance JSON-based relational database built in Rust.
            
            ---
            
            ## üì• Installation
            
            ### Quick Install
            
            | Platform | Method | Command |
            |----------|--------|---------|
            | **Linux (x86_64)** | Direct Download | `wget https://github.com/muhammad-fiaz/RDB/releases/download/v${{ steps.get_version.outputs.version }}/rdb-linux-x86_64 && chmod +x rdb-linux-x86_64 && sudo mv rdb-linux-x86_64 /usr/local/bin/rdb` |
            | **macOS (Intel)** | Direct Download | `curl -L https://github.com/muhammad-fiaz/RDB/releases/download/v${{ steps.get_version.outputs.version }}/rdb-macos-x86_64 -o rdb && chmod +x rdb && sudo mv rdb /usr/local/bin/` |
            | **macOS (Apple Silicon)** | Direct Download | `curl -L https://github.com/muhammad-fiaz/RDB/releases/download/v${{ steps.get_version.outputs.version }}/rdb-macos-aarch64 -o rdb && chmod +x rdb && sudo mv rdb /usr/local/bin/` |
            | **Windows (x64)** | Direct Download | Download `rdb-windows-x86_64.exe` and add to PATH |
            | **Any Platform** | From Source | `cargo install --git https://github.com/muhammad-fiaz/RDB` |
            
            ### Detailed Installation
            
            #### Linux
            ```bash
            # Download
            wget https://github.com/muhammad-fiaz/RDB/releases/download/v${{ steps.get_version.outputs.version }}/rdb-linux-x86_64
            
            # Make executable
            chmod +x rdb-linux-x86_64
            
            # Move to PATH
            sudo mv rdb-linux-x86_64 /usr/local/bin/rdb
            
            # Verify
            rdb --version
            ```
            
            #### macOS
            ```bash
            # Intel Macs
            curl -L https://github.com/muhammad-fiaz/RDB/releases/download/v${{ steps.get_version.outputs.version }}/rdb-macos-x86_64 -o rdb
            
            # Apple Silicon Macs
            curl -L https://github.com/muhammad-fiaz/RDB/releases/download/v${{ steps.get_version.outputs.version }}/rdb-macos-aarch64 -o rdb
            
            # Make executable and move to PATH
            chmod +x rdb
            sudo mv rdb /usr/local/bin/
            
            # Verify
            rdb --version
            ```
            
            #### Windows
            ```powershell
            # Download rdb-windows-x86_64.exe from assets below
            
            # Move to a directory in your PATH, e.g.:
            Move-Item rdb-windows-x86_64.exe C:\Windows\System32\rdb.exe
            
            # Or create a dedicated directory:
            New-Item -ItemType Directory -Path "C:\Program Files\RDB"
            Move-Item rdb-windows-x86_64.exe "C:\Program Files\RDB\rdb.exe"
            
            # Add to PATH
            $env:Path += ";C:\Program Files\RDB"
            
            # Verify
            rdb --version
            ```
            
            ---
            
            ## üöÄ Quick Start
            
            ```bash
            # Initialize RDB
            rdb init
            
            # Start server
            rdb start
            
            # Create your first table
            curl -X POST http://localhost:8080/query \
              -H "Content-Type: application/json" \
              -d '{
                "CreateTable": {
                  "database": "main",
                  "table": "users",
                  "columns": [
                    {"name": "id", "type": "int", "primary_key": true},
                    {"name": "name", "type": "string"}
                  ]
                }
              }'
            ```
            
            ---
            
            ## ‚ú® What's New
            
            ${{ steps.changelog.outputs.content }}
            
            ---
            
            ## üìä System Requirements
            
            | Component | Minimum | Recommended |
            |-----------|---------|-------------|
            | **RAM** | 512 MB | 2 GB+ |
            | **Disk** | 100 MB | 1 GB+ |
            | **CPU** | 1 core | 4+ cores |
            | **OS** | Linux 3.2+, macOS 10.12+, Windows 10+ | Latest |
            
            ---
            
            ## üîß Troubleshooting
            
            ### Common Issues
            
            #### "Address already in use"
            ```bash
            # Use different port
            rdb start --port 9090
            ```
            
            #### "Permission denied"
            ```bash
            # On Linux/macOS, ensure executable
            chmod +x rdb
            
            # On Windows, run as Administrator
            ```
            
            #### "Cannot connect to server"
            ```bash
            # Check if server is running
            curl http://localhost:8080/
            
            # Check firewall settings
            ```
            
            ### Get Help
            - üìñ **Docs:** https://github.com/muhammad-fiaz/RDB/tree/main/docs
            - üêõ **Issues:** https://github.com/muhammad-fiaz/RDB/issues
            - üí¨ **Discussions:** https://github.com/muhammad-fiaz/RDB/discussions
            
            ---
            
            ## üìù Changelog
            
            See [CHANGELOG.md](https://github.com/muhammad-fiaz/RDB/blob/main/CHANGELOG.md) for detailed changes.
            
            ---
            
            ## üìÑ License
            
            Licensed under the Apache License 2.0 - see [LICENSE](https://github.com/muhammad-fiaz/RDB/blob/main/LICENSE) for details.
            
            ---
            
            **Full documentation:** https://github.com/muhammad-fiaz/RDB/tree/main/docs
  build-linux:
    name: Build Linux
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Build
        run: cargo build --release

      - name: Upload artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./target/release/rdb
          asset_name: rdb-linux-x86_64
          asset_content_type: application/octet-stream

  build-macos-intel:
    name: Build macOS Intel
    needs: create-release
    runs-on: macos-13
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Build
        run: cargo build --release

      - name: Upload artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./target/release/rdb
          asset_name: rdb-macos-x86_64
          asset_content_type: application/octet-stream

  build-macos-arm:
    name: Build macOS (ARM)
    needs: create-release
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Build
        run: cargo build --release

      - name: Upload artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./target/release/rdb
          asset_name: rdb-macos-aarch64
          asset_content_type: application/octet-stream

  build-windows:
    name: Build Windows
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Build
        run: cargo build --release

      - name: Upload artifact
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./target/release/rdb.exe
          asset_name: rdb-windows-x86_64.exe
          asset_content_type: application/octet-stream
